<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>40ê°€ì§€ ìŠ¤í‚¬ ìš´ëª… ì£¼ì‚¬ìœ„ í„´ì œ ë°°í‹€</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0f172a; /* Slate 900 */
        }
        .game-container {
            max-width: 900px;
            margin: 0 auto;
            min-height: 100vh;
        }
        .stat-bar {
            transition: width 0.3s ease-in-out;
        }
        .skill-button:disabled {
            filter: grayscale(80%);
            cursor: not-allowed;
        }
        /* Custom scrollbar for log area */
        #log-area::-webkit-scrollbar {
            width: 6px;
        }
        #log-area::-webkit-scrollbar-thumb {
            background: #4f46e5;
            border-radius: 3px;
        }
        #log-area::-webkit-scrollbar-track {
            background: #1e293b;
        }
    </style>
</head>
<body class="p-4 sm:p-8">

    <div class="game-container flex flex-col items-center py-4">
        <h1 class="text-3xl font-extrabold mb-4 text-white text-center sm:text-4xl">ğŸ² 45ê°€ì§€ ìŠ¤í‚¬ ìš´ëª… ë“€ì–¼</h1>
        <p id="current-turn-info" class="text-xl font-bold mb-6 text-yellow-300 text-center"></p>
        
        <!-- Main Game Area -->
        <div id="game-area" class="w-full bg-slate-800 p-4 sm:p-6 rounded-2xl shadow-2xl border-4 border-indigo-700">

            <!-- Player Panels -->
            <div class="flex flex-col sm:flex-row justify-between gap-4 mb-6">
                <!-- Player 1 Panel -->
                <div id="player-panel-0" class="w-full sm:w-1/2 p-4 rounded-xl shadow-lg border border-purple-500 bg-slate-700">
                    <h2 class="text-2xl font-bold text-indigo-300 mb-2">ğŸ›¡ï¸ í”Œë ˆì´ì–´ 1</h2>
                    <div id="stats-0"></div>
                </div>

                <!-- Player 2 Panel -->
                <div id="player-panel-1" class="w-full sm:w-1/2 p-4 rounded-xl shadow-lg border border-red-500 bg-slate-700">
                    <h2 class="text-2xl font-bold text-red-300 mb-2">âš”ï¸ í”Œë ˆì´ì–´ 2</h2>
                    <div class="text-lg text-gray-400">ë°©ì–´ë ¥: <span id="defense-1">10</span></div>
                    <div id="stats-1"></div>
                </div>
            </div>

            <!-- Destiny Dice Info -->
            <div id="dice-info" class="bg-gray-900 p-3 rounded-xl text-center mb-4 border border-yellow-500">
                <span id="dice-text" class="text-lg font-semibold text-yellow-400">ìš´ëª… ì£¼ì‚¬ìœ„: ëŒ€ê¸° ì¤‘...</span>
            </div>
            
            <!-- Field Effect Info -->
            <div id="field-info" class="bg-gray-900 p-3 rounded-xl text-center mb-6 border border-purple-500">
                <span id="field-text" class="text-lg font-semibold text-purple-400">í•„ë“œ ìƒíƒœ: ì—†ìŒ</span>
            </div>


            <!-- Log Area -->
            <div id="log-area" class="h-40 overflow-y-auto bg-gray-900 p-3 rounded-lg text-sm mb-6 border border-gray-600">
                <p class="text-yellow-400">ê²Œì„ì„ ì‹œì‘í•˜ë ¤ë©´ 45ê°€ì§€ ìŠ¤í‚¬ ì¤‘ 5ê°€ì§€ë¥¼ ì„ íƒí•˜ì„¸ìš”.</p>
            </div>

            <!-- Skill Buttons (Current Player) -->
            <div id="current-player-skills" class="grid grid-cols-2 md:grid-cols-3 gap-3">
                <!-- Buttons will be injected here -->
            </div>
            
        </div>

        <!-- Skill Selection Modal -->
        <div id="setup-modal" class="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center p-4 z-20">
            <div class="bg-slate-800 p-6 rounded-xl shadow-2xl w-full max-w-lg border-4 border-indigo-500">
                <h2 id="setup-title" class="text-2xl font-bold text-white mb-4">í”Œë ˆì´ì–´ 1 ìŠ¤í‚¬ ì„ íƒ (5/5)</h2>
                <p class="text-sm text-gray-400 mb-4">45ê°€ì§€ ìŠ¤í‚¬ ì¤‘ 5ê°€ì§€ë¥¼ ì„ íƒí•˜ì„¸ìš”.</p>
                <div id="skill-selection-grid" class="grid grid-cols-2 gap-3 max-h-80 overflow-y-auto pr-2">
                    <!-- All 45 skills go here -->
                </div>
                <button id="confirm-skills-btn" onclick="confirmSkillSelection()" disabled class="mt-6 w-full py-3 rounded-lg font-bold text-gray-900 bg-gray-500 transition duration-200">
                    ì„ íƒ ì™„ë£Œ (5/5)
                </button>
            </div>
        </div>

        <!-- Game Over Message -->
        <div id="game-message" class="hidden fixed inset-0 bg-gray-900 bg-opacity-95 flex flex-col items-center justify-center p-8 z-30">
            <div class="bg-indigo-700 p-8 rounded-xl shadow-2xl text-center">
                <h2 id="final-result" class="text-3xl font-bold text-white mb-4"></h2>
                <p id="final-message" class="text-lg text-indigo-100 mb-6"></p>
                <button onclick="resetGame()" class="bg-yellow-400 hover:bg-yellow-500 text-gray-900 font-bold py-3 px-6 rounded-lg transition duration-200 shadow-md">
                    ë‹¤ì‹œ ì‹œì‘
                </button>
            </div>
        </div>
    </div>

<script>
    // --- ê²Œì„ ìƒíƒœ ë° ë°ì´í„° ì •ì˜ ---
    const MAX_HP = 1000;
    const BASE_MAX_MP = 100; // ê¸°ë³¸ ìµœëŒ€ MP
    const BASE_ATTACK = 100;
    
    // Skill IDs 1-45 (45ê°€ì§€ ìŠ¤í‚¬)
    const SKILLS = [
        { id: 1, name: "ì¼ë°˜ ê³µê²©", cost: 0, damage_multiplier: 1.0, type: "attack", effect_desc: "ê¸°ë³¸ ê³µê²©. MPë¥¼ ì†Œëª¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤." },
        { id: 2, name: "ì—°ì† ë² ê¸°", cost: 15, damage_multiplier: 0.6, type: "attack_multihit", hits: 3, effect_desc: "ì•½í•œ ê³µê²©ì„ 3íšŒ ì‹¤ì‹œí•©ë‹ˆë‹¤." },
        { id: 3, name: "ë³´í˜¸ì˜ ê¸°ë„", cost: 30, damage_multiplier: 0, type: "buff", effect_desc: "2í„´ ë™ì•ˆ ë°›ëŠ” í”¼í•´ 30% ê°ì†Œ ë²„í”„ë¥¼ ì–»ìŠµë‹ˆë‹¤. (í”¼í•´ ê°ì†Œ)" },
        { id: 4, name: "ì˜í˜¼ í¡ìˆ˜", cost: 40, damage_multiplier: 1.5, type: "attack_heal", effect_desc: "í”¼í•´ì˜ 50%ë¥¼ ì²´ë ¥ìœ¼ë¡œ íšŒë³µí•©ë‹ˆë‹¤." },
        { id: 5, name: "ë§ˆë²• í­ì£¼", cost: 50, damage_multiplier: 2.5, type: "attack_selfdmg", effect_desc: "ê°•ë ¥í•œ í”¼í•´ë¥¼ ì…íˆì§€ë§Œ, ìµœëŒ€ HPì˜ 10%ë¥¼ ìí•´í•©ë‹ˆë‹¤." },
        { id: 6, name: "ì •í™”ì˜ íŒŒë™", cost: 35, damage_multiplier: 0, type: "heal_cleanse", effect_desc: "ìµœëŒ€ HPì˜ 15%ë¥¼ íšŒë³µí•˜ê³  í•´ë¡œìš´ íš¨ê³¼ë¥¼ 1ê°œ ì œê±°í•©ë‹ˆë‹¤." },
        { id: 7, name: "ê¸°ë ¥ íšŒë³µ", cost: 0, damage_multiplier: 0, type: "utility", effect_desc: "ìµœëŒ€ HPì˜ 5%ë¥¼ íšŒë³µí•˜ê³  MPë¥¼ 30 ì–»ìŠµë‹ˆë‹¤." },
        { id: 8, name: "ë¬´ë ¥í™”", cost: 25, damage_multiplier: 0, type: "debuff", effect_desc: "2í„´ ë™ì•ˆ ëŒ€ìƒì˜ ê³µê²©ë ¥ì„ 40% ê°ì†Œì‹œí‚µë‹ˆë‹¤. (ë¬´ë ¥í™”)" },
        { id: 9, name: "ë§¹ë… ì£¼ì…", cost: 45, damage_multiplier: 0.5, type: "attack_dot", effect_desc: "í”¼í•´ë¥¼ ì…íˆê³  3í„´ ë™ì•ˆ í„´ë‹¹ 50ì˜ ì¤‘ë… í”¼í•´ë¥¼ ì…í™ë‹ˆë‹¤. (ë§¹ë… ì£¼ì…)" },
        { id: 10, name: "ìš´ëª… ê±°ë¶€", cost: 60, damage_multiplier: 0, type: "defense_dice", effect_desc: "ë‹¤ìŒ í„´ì— ë°œë™í•  ìš´ëª… ì£¼ì‚¬ìœ„ íš¨ê³¼ë¥¼ ì™„ì „íˆ ë¬´ì‹œí•©ë‹ˆë‹¤. (ìš´ëª… ê±°ë¶€)" },
        { id: 11, name: "ì‹œê°„ ì •ì§€", cost: 70, damage_multiplier: 0, type: "debuff_skip_opponent", effect_desc: "ë§¤ìš° ë†’ì€ MPë¥¼ ì†Œëª¨í•˜ì—¬ ìƒëŒ€ì˜ ë‹¤ìŒ 2í„´ì„ ì™„ì „íˆ ìŠ¤í‚µí•©ë‹ˆë‹¤." },
        { id: 12, name: "ë§ˆë‚˜ í™•ì¥ (ì†Œ)", cost: 20, damage_multiplier: 0, type: "utility_mp_max_increase", mp_increase: 10, mp_restore: 5, effect_desc: "ì˜êµ¬ì ìœ¼ë¡œ ìµœëŒ€ MPë¥¼ 10 ì¦ê°€ì‹œí‚¤ê³ , í˜„ì¬ MPë¥¼ 5 íšŒë³µí•©ë‹ˆë‹¤." },
        { id: 13, name: "ë°©ì–´ ë¬´ì‹œ ì¼ê²©", cost: 40, damage_multiplier: 1.2, type: "attack_true_damage", effect_desc: "ìƒëŒ€ ë°©ì–´ë ¥ì„ ì™„ì „íˆ ë¬´ì‹œí•˜ëŠ” 1.2ë°° ê°•ë ¥í•œ ê³µê²©ì„ í•©ë‹ˆë‹¤." },
        { id: 14, name: "ìš´ëª… ì¡°ì‘", cost: 50, damage_multiplier: 0, type: "utility_dice_control", effect_desc: "ë‹¤ìŒ í„´ ìš´ëª… ì£¼ì‚¬ìœ„ë¥¼ +20% ìœ ë¦¬í•˜ê²Œ ì¡°ì‘í•©ë‹ˆë‹¤. (ìš´ëª… ì¡°ì‘)" },
        { id: 15, name: "ê¸‰ì†Œ ë…¸ë¦¬ê¸°", cost: 30, damage_multiplier: 0.8, type: "debuff_crit_vulnerable", effect_desc: "ì•½í•œ í”¼í•´(0.8ë°°)ë¥¼ ì…íˆê³ , 2í„´ ë™ì•ˆ ì¹˜ëª…íƒ€ í”¼í•´(2ë°°)ë¥¼ ë°›ì„ í™•ë¥ ì„ 50%ë¡œ ë§Œë“­ë‹ˆë‹¤. (ê¸‰ì†Œ ë…¸ì¶œ)" },
        { id: 16, name: "í”¼ì˜ ê³„ì•½", cost: 0, damage_multiplier: 0, type: "utility_transfer_hp_mp", effect_desc: "í˜„ì¬ HPì˜ 20%ë¥¼ ì†Œëª¨í•˜ì—¬ MPë¡œ ì¦‰ì‹œ ë³€í™˜í•©ë‹ˆë‹¤. (HPê°€ 100 ì´ìƒì¼ ë•Œë§Œ ê°€ëŠ¥)" },
        { id: 17, name: "í™˜ì˜ ë¶„ì‹ ", cost: 40, damage_multiplier: 0, type: "buff_evade", effect_desc: "ë‹¤ìŒ í„´ ìƒëŒ€ì˜ ê³µê²©ì„ 50% í™•ë¥ ë¡œ íšŒí”¼í•©ë‹ˆë‹¤. (í™˜ì˜ ë¶„ì‹ )" },
        { id: 18, name: "ë§ˆë‚˜ ê°•íƒˆ", cost: 35, damage_multiplier: 0, type: "debuff_mp_steal", effect_desc: "ìƒëŒ€ë°©ì˜ MP 20ì„ í›”ì³ì™€ ìì‹ ì˜ MPë¡œ ë§Œë“­ë‹ˆë‹¤." },
        { id: 19, name: "ìµœí›„ì˜ ì €í•­", cost: 60, damage_multiplier: 0, type: "defense_last_stand", effect_desc: "HP 300 ì´í•˜ì¼ ë•Œë§Œ ì‚¬ìš© ê°€ëŠ¥. HP 100 íšŒë³µ ë° 3í„´ ë™ì•ˆ í”¼í•´ ê°ì†Œ 50% ë²„í”„ë¥¼ ì–»ìŠµë‹ˆë‹¤. (í”¼í•´ ê°ì†Œ)" },
        { id: 20, name: "ê´‘ì—­ ì •í™”", cost: 50, damage_multiplier: 0, type: "cleanse_all", effect_desc: "ìì‹ ì—ê²Œ ê±¸ë¦° ëª¨ë“  í•´ë¡œìš´ íš¨ê³¼ë¥¼ ì œê±°í•˜ê³ , MPë¥¼ 10 íšŒë³µí•©ë‹ˆë‹¤." },
        
        // --- ì¹´ìš´í„°/ë°˜ì‘í˜• ìŠ¤í‚¬ 10ê°€ì§€ (ID 21-30) ---
        { id: 21, name: "ì›ì†Œ ë°˜ì‚¬ë§‰", cost: 45, damage_multiplier: 0, type: "buff_reflect_magic", effect_desc: "1í„´ ë™ì•ˆ ë°›ëŠ” ë§ˆë²• í”¼í•´(MP ì†Œëª¨ ìŠ¤í‚¬)ë¥¼ 100% ë°˜ì‚¬í•©ë‹ˆë‹¤." },
        { id: 22, name: "í•„ì‚¬ì˜ ë°©íŒ¨", cost: 30, damage_multiplier: 0, type: "defense_shield_absorb", absorb_amount: 300, effect_desc: "1í„´ ë™ì•ˆ 300 í”¼í•´ë¥¼ í¡ìˆ˜í•˜ëŠ” ë³´í˜¸ë§‰ì„ ì–»ìŠµë‹ˆë‹¤. (ì¤‘ì²© ë¶ˆê°€)" },
        { id: 23, name: "í”¼í•´ ì „í™˜", cost: 50, damage_multiplier: 0, type: "buff_redirect_damage", effect_desc: "2í„´ ë™ì•ˆ ë°›ëŠ” í”¼í•´ì˜ 50%ë¥¼ ìì‹ ì˜ MPë¡œ ì „í™˜í•©ë‹ˆë‹¤. (í”¼í•´ ì „í™˜)" },
        { id: 24, name: "ë³µìˆ˜ì˜ ì¼ê²©", cost: 40, damage_multiplier: 1.0, type: "attack_conditional_crit", effect_desc: "ìƒëŒ€ë°©ì´ ë‚˜ì—ê²Œ ë””ë²„í”„ê°€ ê±¸ë¦° ìƒíƒœì¼ ê²½ìš°, 3.0ë°°ì˜ ì¹˜ëª…íƒ€ í”¼í•´ë¥¼ ì…í™ë‹ˆë‹¤." },
        { id: 25, name: "ê²€í’ì°¸", cost: 40, damage_multiplier: 0.7, type: "attack_multihit_debuff", hits: 2, effect_desc: "ì•½í•œ í”¼í•´(0.7ë°°)ë¥¼ 2íšŒ ì…íˆê³ , 2í„´ ë™ì•ˆ ìƒëŒ€ì˜ ë°©ì–´ë ¥ì„ 10 ê°ì†Œì‹œí‚¤ëŠ” ë””ë²„í”„ë¥¼ ê²ë‹ˆë‹¤. (ë°©ì–´ë ¥ ê°ì†Œ)" },
        { id: 26, name: "ê¶ê·¹ì˜ ì¸ë‚´", cost: 70, damage_multiplier: 0, type: "defense_damage_cap", effect_desc: "2í„´ ë™ì•ˆ, í•œ ë²ˆì— ë°›ëŠ” í”¼í•´ê°€ ìµœëŒ€ 200ì„ ë„˜ì§€ ì•Šë„ë¡ ì œí•œí•©ë‹ˆë‹¤." },
        { id: 27, name: "í¡ê³µ", cost: 35, damage_multiplier: 0, type: "debuff_mp_reflect", effect_desc: "2í„´ ë™ì•ˆ ìƒëŒ€ê°€ MP ì†Œëª¨ ìŠ¤í‚¬ ì‚¬ìš© ì‹œ, ì†Œëª¨ëŸ‰ì˜ 50%ë¥¼ ìì‹ ì´ íšŒë³µí•©ë‹ˆë‹¤. (í¡ê³µ)" },
        { id: 28, name: "íŒŒì‡„ì˜ ì¹´ìš´í„°", cost: 55, damage_multiplier: 0, type: "buff_counter_debuff", effect_desc: "1í„´ ë™ì•ˆ ê³µê²©ì„ ë°›ì„ ê²½ìš°, ìƒëŒ€ì—ê²Œ 2í„´ê°„ 'ë°©ì–´ë ¥ 50% ê°ì†Œ' ë””ë²„í”„ë¥¼ ê²ë‹ˆë‹¤." },
        { id: 29, name: "ë§ˆë‚˜ í™•ì¥ (ëŒ€)", cost: 50, damage_multiplier: 0, type: "utility_mp_max_increase_heavy", mp_increase: 25, mp_restore: 10, effect_desc: "ì˜êµ¬ì ìœ¼ë¡œ ìµœëŒ€ MPë¥¼ 25 ì¦ê°€ì‹œí‚¤ê³ , í˜„ì¬ MPë¥¼ 10 íšŒë³µí•©ë‹ˆë‹¤." },
        { id: 30, name: "ì—­ì „ì˜ ê¸°íšŒ", cost: 0, damage_multiplier: 0, type: "utility_swap_stats", effect_desc: "HP 20% ë¯¸ë§Œì¼ ë•Œë§Œ ì‚¬ìš© ê°€ëŠ¥. ìì‹ ì˜ í˜„ì¬ HPì™€ ìƒëŒ€ë°©ì˜ í˜„ì¬ HPë¥¼ ë§ë°”ê¿‰ë‹ˆë‹¤." },

        // --- ê³µê²©/ìœ í‹¸ ìŠ¤í‚¬ 10ê°€ì§€ (ID 31-40) ---
        { id: 31, name: "ì¶©ê²©íŒŒ", cost: 35, damage_multiplier: 1.0, type: "attack_mp_drain", effect_desc: "ì¼ë°˜ í”¼í•´ í›„ ìƒëŒ€ì˜ MPë¥¼ 10 ê°ì†Œì‹œí‚µë‹ˆë‹¤. (ê´‘ì—­ ê³µê²©)" },
        { id: 32, name: "ì§‘ì¤‘ ì‚¬ê²©", cost: 50, damage_multiplier: 0.4, type: "attack_multihit_crit", hits: 5, effect_desc: "ì•½í•œ í”¼í•´(0.4ë°°)ë¥¼ 5íšŒ ì…íˆê³ , ê° íƒ€ê²©ì€ 40% í™•ë¥ ë¡œ ì¹˜ëª…íƒ€ì…ë‹ˆë‹¤." },
        { id: 33, name: "ë§ˆë ¥ í¬ê²©", cost: 60, damage_multiplier: 1.5, type: "attack_mp_based", effect_desc: "ê°•ë ¥í•œ í”¼í•´(1.5ë°°)ë¥¼ ì…íˆê³ , í˜„ì¬ MPê°€ ë†’ì„ìˆ˜ë¡ ì¶”ê°€ í”¼í•´(MP 1ë‹¹ +1)ë¥¼ ì…í™ë‹ˆë‹¤." },
        { id: 34, name: "ì§€ì—° í­ë°œ", cost: 45, damage_multiplier: 0, type: "debuff_delayed_damage", effect_desc: "ì¦‰ì‹œ í”¼í•´ëŠ” ì—†ì§€ë§Œ, 2í„´ í›„ 300ì˜ ê³ ì • í”¼í•´ë¥¼ ì…íˆëŠ” ë””ë²„í”„ë¥¼ ê²ë‹ˆë‹¤. (ì§€ì—° í­ë°œ)" },
        { id: 35, name: "ì••ë„ì ì¸ í˜", cost: 70, damage_multiplier: 3.0, type: "attack_conditional_defense", effect_desc: "ë§¤ìš° ê°•ë ¥í•œ í”¼í•´(3.0ë°°)ë¥¼ ì…í™ë‹ˆë‹¤. ìƒëŒ€ì˜ ë°©ì–´ë ¥ì´ 15 ì´ìƒì¼ ë•Œë§Œ ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤." },
        { id: 36, name: "ì‡ ì•½ì˜ ì¼ê²©", cost: 30, damage_multiplier: 0.7, type: "attack_debuff_heal_reduc", effect_desc: "ì•½í•œ í”¼í•´(0.7ë°°)ë¥¼ ì…íˆê³ , 3í„´ ë™ì•ˆ ìƒëŒ€ì˜ ëª¨ë“  íšŒë³µ íš¨ê³¼ë¥¼ 50% ê°ì†Œì‹œí‚µë‹ˆë‹¤. (íšŒë³µ ê°ì†Œ)" },
        { id: 37, name: "ì‹ ì† ê²©íŒŒ", cost: 40, damage_multiplier: 1.1, type: "attack_fast_cast", effect_desc: "í”¼í•´(1.1ë°°)ë¥¼ ì…íˆê³ , ì´ë²ˆ í„´ì˜ ìš´ëª… ì£¼ì‚¬ìœ„ íš¨ê³¼ë¥¼ 1.0ìœ¼ë¡œ ì´ˆê¸°í™”í•©ë‹ˆë‹¤." },
        { id: 38, name: "ë°©ì–´ ë¶•ê´´", cost: 55, damage_multiplier: 1.3, type: "attack_defense_break", effect_desc: "ê°•ë ¥í•œ í”¼í•´(1.3ë°°)ë¥¼ ì…íˆê³ , ìƒëŒ€ì˜ í˜„ì¬ ë°©ì–´ë ¥ 5ë¥¼ ì˜êµ¬ì ìœ¼ë¡œ ê°ì†Œì‹œí‚µë‹ˆë‹¤." },
        { id: 39, name: "ìƒëª… ì „í™˜", cost: 0, damage_multiplier: 1.0, type: "attack_hp_cost", effect_desc: "ì¼ë°˜ í”¼í•´ë¥¼ ì…íˆê³ , MP ëŒ€ì‹  í˜„ì¬ HPì˜ 10%ë¥¼ ì†Œëª¨í•©ë‹ˆë‹¤. (HP 100 ì´ìƒ ì‹œ ì‚¬ìš© ê°€ëŠ¥)" },
        { id: 40, name: "íšŒë³µ ë´‰ì‡„", cost: 50, damage_multiplier: 1.0, type: "attack_block_heal", effect_desc: "ì¼ë°˜ í”¼í•´ë¥¼ ì…íˆê³ , 2í„´ ë™ì•ˆ ìƒëŒ€ì˜ íšŒë³µ ìŠ¤í‚¬ ì‚¬ìš©ì„ ë´‰ì‡„í•©ë‹ˆë‹¤. (íšŒë³µ ë´‰ì‡„)" },

        // --- í•„ë“œ ìŠ¤í‚¬ 5ê°€ì§€ (ID 41-45) ---
        { id: 41, name: "ì¤‘ë ¥ì¥", cost: 70, damage_multiplier: 0, type: "field_mp_cost_increase", duration: 3, effect_desc: "3í„´ ë™ì•ˆ, ëª¨ë“  ìŠ¤í‚¬ì˜ MP ì†Œëª¨ëŸ‰ì´ 50% ì¦ê°€í•©ë‹ˆë‹¤. (ì–‘ìª½ ëª¨ë‘ ì ìš©)" },
        { id: 42, name: "ê°€ì†ì¥", cost: 60, damage_multiplier: 0, type: "field_haste_boost", duration: 2, effect_desc: "2í„´ ë™ì•ˆ, í„´ ì‹œì‘ ì‹œ MP íšŒë³µëŸ‰ì´ 2ë°°, í„´ë‹¹ ê³µê²©ë ¥ì´ 100 ì¦ê°€í•©ë‹ˆë‹¤. (ì–‘ìª½ ëª¨ë‘ ì ìš©)" },
        { id: 43, name: "ë¯¸ë‹¤ìŠ¤ ì¥", cost: 55, damage_multiplier: 0, type: "field_damage_to_mp", duration: 3, effect_desc: "3í„´ ë™ì•ˆ, ê³µê²© ìŠ¤í‚¬ë¡œ ì…íŒ í”¼í•´ì˜ 10%ë¥¼ MPë¡œ íšŒë³µí•©ë‹ˆë‹¤. (ì–‘ìª½ ëª¨ë‘ ì ìš©)" },
        { id: 44, name: "ì¹¨ë¬µì¥", cost: 65, damage_multiplier: 0, type: "field_non_attack_cost_increase", duration: 2, effect_desc: "2í„´ ë™ì•ˆ, ë¹„ê³µê²© ìŠ¤í‚¬ì˜ MP ì†Œëª¨ëŸ‰ì´ 100% ì¦ê°€í•©ë‹ˆë‹¤. (ì–‘ìª½ ëª¨ë‘ ì ìš©)" },
        { id: 45, name: "í˜¼ëˆì¥", cost: 75, damage_multiplier: 0, type: "field_random_damage", duration: 2, effect_desc: "2í„´ ë™ì•ˆ, ëª¨ë“  ê³µê²© ìŠ¤í‚¬ì˜ ìµœì¢… í”¼í•´ì— -50%ì—ì„œ +50%ì˜ ë¬´ì‘ìœ„ ë³€ë™ì´ ì ìš©ë©ë‹ˆë‹¤. (ì–‘ìª½ ëª¨ë‘ ì ìš©)" },
    ];

    let players = [];
    let currentPlayerIndex = 0;
    let turnCount = 0;
    let diceModifier = 1.0;
    let setupStep = 1; // 1: P1 select, 2: P2 select, 3: Battle

    // --- ê¸€ë¡œë²Œ í•„ë“œ íš¨ê³¼ ìƒíƒœ ---
    let FIELD_EFFECT = {
        name: 'ì—†ìŒ',
        type: null,
        duration: 0
    };

    // --- DOM ìš”ì†Œ ìºì‹± ---
    const $logArea = document.getElementById('log-area');
    const $currentTurnInfo = document.getElementById('current-turn-info');
    const $currentPlayerSkills = document.getElementById('current-player-skills');
    const $gameMessage = document.getElementById('game-message');
    const $finalResult = document.getElementById('final-result');
    const $finalMessage = document.getElementById('final-message');
    const $diceText = document.getElementById('dice-text');
    const $fieldText = document.getElementById('field-text'); // New field text
    const $setupModal = document.getElementById('setup-modal');
    const $setupTitle = document.getElementById('setup-title');
    const $skillSelectionGrid = document.getElementById('skill-selection-grid');
    const $confirmSkillsBtn = document.getElementById('confirm-skills-btn');

    // --- í—¬í¼ í•¨ìˆ˜ ---

    /** ë¡œê·¸ ë©”ì‹œì§€ ì¶”ê°€ ë° ìŠ¤í¬ë¡¤ */
    function addLog(message, color = 'text-gray-200') {
        const p = document.createElement('p');
        p.className = `p-1 ${color} border-b border-slate-700`;
        p.innerHTML = `[í„´ ${turnCount}] ${message}`;
        $logArea.appendChild(p);
        $logArea.scrollTop = $logArea.scrollHeight;
    }

    /** ìŠ¤í‚¬ì˜ ì‹¤ì œ MP ì†Œëª¨ëŸ‰ ê³„ì‚° (í•„ë“œ íš¨ê³¼ ì ìš©) */
    function calculateSkillCost(skill) {
        if (skill.cost === 0 || skill.type === 'attack_hp_cost') return 0;
        
        let cost = skill.cost;

        // 1. ì¤‘ë ¥ì¥ (field_mp_cost_increase): ëª¨ë“  ìŠ¤í‚¬ MP ì†Œëª¨ëŸ‰ 50% ì¦ê°€
        if (FIELD_EFFECT.type === 'field_mp_cost_increase') {
            cost = Math.ceil(cost * 1.5);
        }

        // 2. ì¹¨ë¬µì¥ (field_non_attack_cost_increase): ë¹„ê³µê²© ìŠ¤í‚¬ MP ì†Œëª¨ëŸ‰ 100% ì¦ê°€
        if (FIELD_EFFECT.type === 'field_non_attack_cost_increase') {
            // 'attack'ìœ¼ë¡œ ì‹œì‘í•˜ì§€ ì•ŠëŠ” ìŠ¤í‚¬ íƒ€ì… (ì¼ë°˜ ê³µê²© ì œì™¸)
            if (skill.type !== 'attack' && !skill.type.startsWith('attack_')) {
                cost = Math.ceil(cost * 2.0);
            }
        }
        
        return cost;
    }

    /** UI ì—…ë°ì´íŠ¸ */
    function updateUI() {
        if (setupStep < 3) return; // Only update battle UI in battle step

        players.forEach((p, index) => {
            const $panel = document.getElementById(`stats-${index}`);
            
            // HP/MP Bar rendering
            const hpWidth = Math.max(0, (p.hp / MAX_HP) * 100);
            const mpWidth = Math.max(0, (p.mp / p.max_mp) * 100); 
            
            // Shield status
            const shieldText = p.shield_value > 0 ? `<span class="px-2 py-0.5 text-xs rounded-full bg-blue-500 text-white">ì‰´ë“œ: ${p.shield_value}</span>` : '';

            let statusText = p.status_effects.map(e => {
                let color = e.type.includes('buff') ? 'text-green-300' : 'text-yellow-400';
                return `<span class="px-2 py-0.5 text-xs rounded-full bg-slate-600 ${color}">${e.name} (${e.duration}T)</span>`;
            }).join(' ');
            
            // Combine shield and status effects
            const combinedStatus = `${shieldText} ${statusText}`;

            // ê°€ì†ì¥ìœ¼ë¡œ ì¸í•œ ì„ì‹œ ê³µê²©ë ¥ ì¦ê°€ ê³„ì‚°
            let tempAttackIncrease = 0;
            if (FIELD_EFFECT.type === 'field_haste_boost') {
                tempAttackIncrease = 100;
            }
            const currentAttack = p.base_attack + tempAttackIncrease;

            $panel.innerHTML = `
                <!-- Attack Stat (Visible only when boosted by field) -->
                ${tempAttackIncrease > 0 ? `<div class="text-sm font-medium text-white mb-1">ê³µê²©ë ¥: <span class="text-xl font-bold text-red-400">${currentAttack}</span> (+${tempAttackIncrease})</div>` : ''}

                <!-- Defense Stat -->
                <div class="text-lg font-medium text-white mb-2">ë°©ì–´ë ¥: <span class="text-xl font-bold">${p.defense}</span></div>

                <!-- HP Bar -->
                <div class="mb-1 text-sm font-medium text-white flex justify-between">
                    <span>HP: ${Math.ceil(p.hp)} / ${MAX_HP}</span>
                    <span>${index === currentPlayerIndex ? 'ë‚´ í„´' : 'ìƒëŒ€ í„´'}</span>
                </div>
                <div class="h-3 bg-gray-900 rounded-full overflow-hidden mb-2">
                    <div class="stat-bar h-full ${index === 0 ? 'bg-purple-600' : 'bg-red-600'}" style="width: ${hpWidth}%;"></div>
                </div>

                <!-- MP Bar (Shows current MAX MP) -->
                <div class="mb-1 text-sm font-medium text-white">MP: ${Math.floor(p.mp)} / <span class="text-yellow-300">${p.max_mp}</span></div>
                <div class="h-2 bg-gray-900 rounded-full overflow-hidden mb-3">
                    <div class="stat-bar h-full bg-blue-500" style="width: ${mpWidth}%;"></div>
                </div>

                <!-- Status Effects -->
                <div class="h-8 mb-2">${combinedStatus}</div>
            `;

            // Update skill buttons for current player
            if (index === currentPlayerIndex) {
                renderSkillButtons(p);
            }
        });
        
        // Field Effect Display
        if (FIELD_EFFECT.type) {
            $fieldText.textContent = `í•„ë“œ ìƒíƒœ: ${FIELD_EFFECT.name} (${FIELD_EFFECT.duration}T ë‚¨ìŒ) - ${SKILLS.find(s => s.id === (FIELD_EFFECT.id)).effect_desc}`;
            $fieldText.classList.add('text-red-400');
            $fieldText.classList.remove('text-purple-400');
        } else {
            $fieldText.textContent = 'í•„ë“œ ìƒíƒœ: ì—†ìŒ';
            $fieldText.classList.remove('text-red-400');
            $fieldText.classList.add('text-purple-400');
        }


        // Check Win/Loss
        if (players[0].hp <= 0 || players[1].hp <= 0) {
            endGame();
        }
    }

    /** ìŠ¤í‚¬ ì„ íƒ UI ë Œë”ë§ */
    function renderSkillSelection() {
        $skillSelectionGrid.innerHTML = '';
        SKILLS.forEach(skill => {
            const div = document.createElement('div');
            const isDefaultAttack = skill.id === 1; 

            div.className = `p-3 rounded-lg shadow-md border border-gray-600 transition duration-150 flex flex-col justify-between h-full text-white ${isDefaultAttack ? 'bg-gray-800 opacity-70 cursor-not-allowed' : 'cursor-pointer hover:bg-slate-600 bg-slate-700'}`;
            div.id = `skill-select-${skill.id}`;
            if (!isDefaultAttack) {
                div.onclick = () => toggleSkillSelection(skill.id);
            }
            
            // í•„ë“œ ìŠ¤í‚¬ì€ ë³´ë¼ìƒ‰ í•˜ì´ë¼ì´íŠ¸
            const isFieldSkill = skill.type.startsWith('field_');
            let skillCost = skill.cost;

            div.innerHTML = `
                <div class="text-lg font-semibold ${isFieldSkill ? 'text-purple-400' : ''}">${skill.name} ${isFieldSkill ? '(í•„ë“œ)' : ''}</div>
                <div class="text-sm text-yellow-300 mt-1">MP: ${skillCost}</div>
                <p class="text-xs text-gray-400 mt-2">${skill.effect_desc}</p>
            `;
            $skillSelectionGrid.appendChild(div);
        });
        updateSkillSelectionDisplay();
    }

    let currentSelectedSkills = [1]; // ì¼ë°˜ ê³µê²© (ID 1)ì€ ê¸°ë³¸ ì„ íƒ
    function toggleSkillSelection(skillId) {
        if (skillId === 1) return; 

        const index = currentSelectedSkills.indexOf(skillId);
        const skillElement = document.getElementById(`skill-select-${skillId}`);

        if (index > -1) {
            // Deselect
            currentSelectedSkills.splice(index, 1);
            skillElement.classList.remove('ring-4', 'ring-indigo-400', 'bg-indigo-900');
            skillElement.classList.add('bg-slate-700');
        } else if (currentSelectedSkills.length < 5) {
            // Select
            currentSelectedSkills.push(skillId);
            skillElement.classList.add('ring-4', 'ring-indigo-400', 'bg-indigo-900');
            skillElement.classList.remove('bg-slate-700');
        } else {
            addLog("ìŠ¤í‚¬ì€ 5ê°œê¹Œì§€ë§Œ ì„ íƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.", 'text-red-400');
        }
        updateSkillSelectionDisplay();
    }

    function updateSkillSelectionDisplay() {
        const count = currentSelectedSkills.length; 
        
        $confirmSkillsBtn.textContent = `ì„ íƒ ì™„ë£Œ (${count}/5)`;
        
        if (count === 5) {
            $confirmSkillsBtn.disabled = false;
            $confirmSkillsBtn.classList.replace('bg-gray-500', 'bg-indigo-500');
            $confirmSkillsBtn.classList.add('hover:bg-indigo-600');
        } else {
            $confirmSkillsBtn.disabled = true;
            $confirmSkillsBtn.classList.replace('bg-indigo-500', 'bg-gray-500');
            $confirmSkillsBtn.classList.remove('hover:bg-indigo-600');
        }
        $setupTitle.textContent = `${players[setupStep - 1].name} ìŠ¤í‚¬ ì„ íƒ (${count}/5)`;
    }

    function confirmSkillSelection() {
        const playerIndex = setupStep - 1;
        
        // Map skill IDs to actual skill objects
        players[playerIndex].selected_skills = currentSelectedSkills.map(id => SKILLS.find(s => s.id === id));
        currentSelectedSkills = [1]; // Reset for next player (or battle)
        
        if (setupStep === 1) {
            setupStep = 2;
            // Reset UI for Player 2
            $skillSelectionGrid.innerHTML = '';
            renderSkillSelection();
            
        } else if (setupStep === 2) {
            // Setup complete, start battle
            setupStep = 3;
            $setupModal.classList.add('hidden');
            addLog('ëª¨ë“  í”Œë ˆì´ì–´ì˜ ìŠ¤í‚¬ ì„ íƒì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ì „íˆ¬ ì‹œì‘!', 'text-green-500');
            startTurn();
        }
    }


    /** ê²Œì„ ì¢…ë£Œ ì²˜ë¦¬ */
    function endGame() {
        currentPlayerIndex = -1; // End game state
        $gameMessage.classList.remove('hidden');

        const p1Dead = players[0].hp <= 0;
        const p2Dead = players[1].hp <= 0;

        if (p1Dead && p2Dead) {
            $finalResult.textContent = 'ë¬´ìŠ¹ë¶€!';
            $finalMessage.textContent = 'ìš´ëª… ì£¼ì‚¬ìœ„ê°€ ë„ˆë¬´ ê°•í–ˆìŠµë‹ˆë‹¤. ë™ì‹œì— ì“°ëŸ¬ì¡ŒìŠµë‹ˆë‹¤.';
            $finalResult.classList.add('text-yellow-400');
        } else if (p1Dead) {
            $finalResult.textContent = 'í”Œë ˆì´ì–´ 2 ìŠ¹ë¦¬!';
            $finalMessage.textContent = `í”Œë ˆì´ì–´ 1ì„ ë¬¼ë¦¬ì³¤ìŠµë‹ˆë‹¤! ì´ ${turnCount}í„´ ì†Œìš”.`;
            $finalResult.classList.add('text-red-500');
        } else {
            $finalResult.textContent = 'í”Œë ˆì´ì–´ 1 ìŠ¹ë¦¬!';
            $finalMessage.textContent = `í”Œë ˆì´ì–´ 2ë¥¼ ë¬¼ë¦¬ì³¤ìŠµë‹ˆë‹¤! ì´ ${turnCount}í„´ ì†Œìš”.`;
            $finalResult.classList.add('text-purple-500');
        }
    }

    /** ê²Œì„ ì´ˆê¸°í™” */
    function resetGame() {
        players = [
            { id: 0, name: 'í”Œë ˆì´ì–´ 1', hp: MAX_HP, mp: BASE_MAX_MP, max_mp: BASE_MAX_MP, base_attack: BASE_ATTACK, defense: 10, selected_skills: [], status_effects: [], shield_value: 0 },
            { id: 1, name: 'í”Œë ˆì´ì–´ 2', hp: MAX_HP, mp: BASE_MAX_MP, max_mp: BASE_MAX_MP, base_attack: BASE_ATTACK, defense: 10, selected_skills: [], status_effects: [], shield_value: 0 }
        ];
        currentPlayerIndex = 0;
        turnCount = 0;
        diceModifier = 1.0;
        setupStep = 1;
        currentSelectedSkills = [1]; 
        
        FIELD_EFFECT = { name: 'ì—†ìŒ', type: null, duration: 0 }; // í•„ë“œ ìƒíƒœ ì´ˆê¸°í™”

        $logArea.innerHTML = '<p class="text-yellow-400 p-1">ê²Œì„ì„ ì‹œì‘í•˜ë ¤ë©´ 45ê°€ì§€ ìŠ¤í‚¬ ì¤‘ 5ê°€ì§€ë¥¼ ì„ íƒí•˜ì„¸ìš”.</p>';
        $gameMessage.classList.add('hidden');
        $setupModal.classList.remove('hidden');
        $diceText.textContent = 'ìš´ëª… ì£¼ì‚¬ìœ„: ëŒ€ê¸° ì¤‘...';
        
        // Clean up final result class
        $finalResult.classList.remove('text-yellow-400', 'text-red-500', 'text-purple-500');
        
        // Restart setup phase
        renderSkillSelection();
        updateSkillSelectionDisplay();
        updateUI(); 
    }

    /** ìŠ¤í‚¬ ë²„íŠ¼ ë Œë”ë§ (í˜„ì¬ í”Œë ˆì´ì–´ìš©) */
    function renderSkillButtons(player) {
        $currentPlayerSkills.innerHTML = '';
        player.selected_skills.forEach(skill => {
            const cost = calculateSkillCost(skill); // í•„ë“œ íš¨ê³¼ê°€ ì ìš©ëœ ì‹¤ì œ ì½”ìŠ¤íŠ¸
            const button = document.createElement('button');
            button.onclick = () => useSkill(player.id, skill.id);
            
            // íŠ¹ìˆ˜ ì‚¬ìš© ì¡°ê±´ ì²´í¬
            let disabled = player.mp < cost && skill.type !== 'attack_hp_cost';
            let tooltip = skill.effect_desc;
            const target = players[1 - player.id];
            
            // í”¼ì˜ ê³„ì•½ (ID 16) / ìƒëª… ì „í™˜ (ID 39)
            if ((skill.id === 16 || skill.id === 39) && player.hp < 100) { 
                disabled = true;
                tooltip += " (HPê°€ 100 ë¯¸ë§Œì´ë¼ ì‚¬ìš© ë¶ˆê°€)";
            }
            // ìµœí›„ì˜ ì €í•­ (ID 19)
            if (skill.id === 19 && player.hp > 300) { 
                disabled = true;
                tooltip += " (HPê°€ 300ì„ ì´ˆê³¼í•˜ì—¬ ì‚¬ìš© ë¶ˆê°€)";
            }
            // ì—­ì „ì˜ ê¸°íšŒ (ID 30)
            if (skill.id === 30 && player.hp >= MAX_HP * 0.2) { 
                disabled = true;
                tooltip += " (HPê°€ 20% ì´ìƒì´ë¼ ì‚¬ìš© ë¶ˆê°€)";
            }
            // ì••ë„ì ì¸ í˜ (ID 35)
            if (skill.id === 35 && target.defense < 15) { 
                disabled = true;
                tooltip += " (ìƒëŒ€ ë°©ì–´ë ¥ì´ 15 ë¯¸ë§Œì´ë¼ ì‚¬ìš© ë¶ˆê°€)";
            }
            // íšŒë³µ ë´‰ì‡„ (ID 40): íšŒë³µ ìŠ¤í‚¬ ì‚¬ìš© ë¶ˆê°€ ìƒíƒœ ì²´í¬
            const healBlockEffect = player.status_effects.find(e => e.name === 'íšŒë³µ ë´‰ì‡„');
            if (healBlockEffect && (skill.type.includes('heal') || skill.type === 'defense_last_stand')) {
                disabled = true;
                tooltip = `[ë´‰ì‡„ë¨] ${tooltip}`;
            }
            // í•„ë“œ ìŠ¤í‚¬ì€ ì´ë¯¸ ë‹¤ë¥¸ í•„ë“œê°€ ê¹”ë ¤ìˆìœ¼ë©´ ì‚¬ìš© ë¶ˆê°€
            if (skill.type.startsWith('field_') && FIELD_EFFECT.type !== null) {
                disabled = true;
                tooltip += ` (ì´ë¯¸ **${FIELD_EFFECT.name}** í•„ë“œê°€ í™œì„±í™”ë˜ì–´ ì‚¬ìš© ë¶ˆê°€)`;
            }


            button.disabled = disabled;
            const isFieldSkill = skill.type.startsWith('field_');
            
            let buttonClass = 'bg-indigo-600';
            if (isFieldSkill) {
                buttonClass = 'bg-purple-600'; // í•„ë“œ ìŠ¤í‚¬ì€ ë³´ë¼ìƒ‰
            } else if (disabled) {
                buttonClass = 'disabled:opacity-50 disabled:cursor-not-allowed';
            }

            button.className = `skill-button ${buttonClass} text-white font-semibold py-3 px-4 rounded-lg shadow-lg transition duration-200 enabled:hover:bg-indigo-700 text-left flex flex-col justify-between h-full`;
            button.innerHTML = `
                <div class="text-sm sm:text-base">${skill.name}</div>
                <div class="text-xs sm:text-sm font-light text-indigo-200 mt-1">${tooltip} (MP ${cost})</div>
            `;
            $currentPlayerSkills.appendChild(button);
        });
    }

    // --- í„´ ë° ì „íˆ¬ ë¡œì§ ---

    /** í„´ ì‹œì‘ ì‹œ ë¡œì§ */
    function startTurn() {
        if (players[0].hp <= 0 || players[1].hp <= 0) return;

        turnCount++;
        const current = players[currentPlayerIndex];
        const opponent = players[1 - currentPlayerIndex];

        // 0. ìš´ëª… ì£¼ì‚¬ìœ„ ì¡°ì‘ íš¨ê³¼ í™•ì¸ ë° êµ´ë¦¼
        let modifiedDice = diceModifier;
        const fateManipulator = current.status_effects.find(e => e.name === 'ìš´ëª… ì¡°ì‘');
        if (fateManipulator) {
            modifiedDice = 1.2; 
            addLog(`**ìš´ëª… ì¡°ì‘** íš¨ê³¼ë¡œ ìš´ëª… ì£¼ì‚¬ìœ„ê°€ +20%ë¡œ ê³ ì •ë©ë‹ˆë‹¤.`, 'text-indigo-400');
        } else {
            diceModifier = 1 + (Math.random() * 0.3 - 0.15); 
            modifiedDice = diceModifier;
        }

        const fateDenier = current.status_effects.find(e => e.name === 'ìš´ëª… ê±°ë¶€');
        if (fateDenier) {
            modifiedDice = 1.0; 
            addLog(`**ìš´ëª… ê±°ë¶€** íš¨ê³¼ë¡œ ì´ë²ˆ í„´ì˜ ìš´ëª… ì£¼ì‚¬ìœ„ íš¨ê³¼ê°€ ë¬´ì‹œë©ë‹ˆë‹¤.`, 'text-indigo-400');
        }

        diceModifier = modifiedDice;
        const modifierPercent = Math.round((diceModifier - 1) * 100);
        $diceText.textContent = `ìš´ëª… ì£¼ì‚¬ìœ„: ëª¨ë“  íš¨ê³¼ ${modifierPercent >= 0 ? '+' : ''}${modifierPercent}% ë³´ì •`;
        addLog(`**ìš´ëª… ì£¼ì‚¬ìœ„**ê°€ êµ´ë ¤ì¡ŒìŠµë‹ˆë‹¤! ê¸ˆ í„´ì˜ ëª¨ë“  íš¨ê³¼ì— ${modifierPercent}% ë³´ì •ì´ ì ìš©ë©ë‹ˆë‹¤.`, modifierPercent >= 0 ? 'text-green-400' : 'text-red-400');

        // 1. ìƒëŒ€ í„´ ìŠ¤í‚µ íš¨ê³¼ í™•ì¸ (ì‹œê°„ ì •ì§€ ìŠ¤í‚¬)
        const opponentSkipEffect = current.status_effects.find(e => e.name === 'í„´ ìŠ¤í‚µ (ìƒëŒ€)');
        
        // 2. í„´ ì‹œì‘ ì‹œ MP íšŒë³µ ë° ìƒíƒœ íš¨ê³¼ ì²˜ë¦¬ (ìŠ¤í‚µ ì—¬ë¶€ì™€ ê´€ê³„ì—†ì´ ì§€ì† ì‹œê°„ì€ ê°ì†Œ)
        processTurnStart(current, opponent);

        // 3. í•„ë“œ íš¨ê³¼ ì§€ì†ì‹œê°„ ê°ì†Œ
        if (FIELD_EFFECT.type) {
            FIELD_EFFECT.duration--;
            if (FIELD_EFFECT.duration <= 0) {
                addLog(`**${FIELD_EFFECT.name}** í•„ë“œ íš¨ê³¼ê°€ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.`, 'text-purple-400');
                FIELD_EFFECT = { name: 'ì—†ìŒ', type: null, duration: 0 };
            }
        }

        // 4. ë…(DOT) í”¼í•´ ë° ì§€ì—° í­ë°œ ì²˜ë¦¬ (í„´ ì‹œì‘ ì‹œ)
        applyDOTDamage(current);
        applyDelayedDamage(current);
        
        if (opponentSkipEffect) {
            addLog(`**${current.name}**ëŠ” **ì‹œê°„ ì •ì§€** íš¨ê³¼ë¡œ ì¸í•´ í–‰ë™í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. (ë‚¨ì€ í„´: ${opponentSkipEffect.duration})`, 'text-yellow-500');
            
            // í„´ ì „í™˜ (ìŠ¤í‚µ)
            currentPlayerIndex = 1 - currentPlayerIndex;

            // ë‹¤ìŒ í„´ ì‹œì‘ (ë”œë ˆì´ ì—†ì´ ë°”ë¡œ)
            if (players[0].hp > 0 && players[1].hp > 0) {
                updateUI(); // ìŠ¤í‚µëœ í”Œë ˆì´ì–´ì˜ ìƒíƒœ ì—…ë°ì´íŠ¸ í›„
                startTurn();
            }
            return; // í„´ ìŠ¤í‚µ ì‹œ ë‚˜ë¨¸ì§€ ë¡œì§ ìŠ¤í‚µ
        }


        // 5. ì •ìƒì ì¸ í„´ ì§„í–‰
        updateUI();
    }

    /** í„´ ì‹œì‘ íš¨ê³¼ ì²˜ë¦¬ (MP íšŒë³µ, íš¨ê³¼ í„´ ê°ì†Œ) */
    function processTurnStart(current, opponent) {
        // ê¸°ë³¸ MP íšŒë³µ (í„´ ë‹¹ 10)
        let mpRecovery = 10; 
        
        // ê°€ì†ì¥ (field_haste_boost) ì²´í¬
        if (FIELD_EFFECT.type === 'field_haste_boost') {
            mpRecovery *= 2; // MP íšŒë³µëŸ‰ 2ë°° (20)
            addLog(`**ê°€ì†ì¥** íš¨ê³¼ë¡œ ${current.name}ì´(ê°€) MP íšŒë³µëŸ‰ 2ë°° ë° ê³µê²©ë ¥ ì¦ê°€ íš¨ê³¼ë¥¼ ë°›ìŠµë‹ˆë‹¤.`, 'text-purple-300');
        }

        // MP íšŒë³µ - ìµœëŒ€ MPë¥¼ ê³ ë ¤í•˜ì—¬ íšŒë³µ
        current.mp = Math.min(current.max_mp, current.mp + mpRecovery);
        
        // ìƒíƒœ íš¨ê³¼ ì ìš©/ê°ì†Œ ë° ì œê±°
        const processEffects = (player) => {
            player.status_effects = player.status_effects.filter(effect => {
                // ì‹¤ë“œ íš¨ê³¼ëŠ” í„´ ì‹œì‘ ì‹œ í•´ì œ (1í„´ ì§€ì†)
                if (player.shield_value > 0 && effect.duration === 1 && effect.name === 'í•„ì‚¬ì˜ ë°©íŒ¨') {
                    player.shield_value = 0;
                    addLog(`${player.name}ì˜ '${effect.name}' ì‹¤ë“œê°€ í•´ì œë˜ì—ˆìŠµë‹ˆë‹¤.`, 'text-gray-500');
                }
                
                effect.duration--;
                if (effect.duration <= 0) {
                    addLog(`${player.name}ì—ê²Œ ê±¸ë¦° '${effect.name}' íš¨ê³¼ê°€ í•´ì œë˜ì—ˆìŠµë‹ˆë‹¤.`, 'text-gray-500');
                    return false;
                }
                return true;
            });
        };

        // ìì‹ ì˜ ë²„í”„/ë””ë²„í”„ ì§€ì†ì‹œê°„ ê°ì†Œ
        processEffects(current);
        // ìƒëŒ€ë°©ì˜ ë²„í”„/ë””ë²„í”„ ì§€ì†ì‹œê°„ ê°ì†Œ
        processEffects(opponent); 
    }

    /** DOT í”¼í•´ ì ìš© */
    function applyDOTDamage(current) {
        // ë…(DOT) ë””ë²„í”„ í™•ì¸
        current.status_effects.filter(e => e.name === 'ë§¹ë… ì£¼ì…').forEach(e => {
            const damage = Math.floor(50 * diceModifier);
            current.hp -= damage;
            addLog(`${current.name}ì´(ê°€) ë… í”¼í•´ ${damage}ë¥¼ ì…ì—ˆìŠµë‹ˆë‹¤.`, 'text-red-400');
        });
    }

    /** ì§€ì—° í­ë°œ í”¼í•´ ì ìš© */
    function applyDelayedDamage(current) {
        // ì§€ì—° í­ë°œ ë””ë²„í”„ í™•ì¸
        current.status_effects.filter(e => e.name === 'ì§€ì—° í­ë°œ' && e.duration === 0).forEach(e => {
            const damage = 300; // ê³ ì • í”¼í•´ 300
            current.hp -= damage;
            // ì§€ì—° í­ë°œ ë””ë²„í”„ëŠ” durationì´ 0ì¼ ë•Œ (ì¦‰, 2í„´ì´ ì§€ë‚œ í›„ í„´ ì‹œì‘ ì‹œ) ë°œë™ë˜ë¯€ë¡œ, ì—¬ê¸°ì„œ ì œê±°
            current.status_effects = current.status_effects.filter(effect => effect !== e);
            addLog(`${current.name}ì—ê²Œ **ì§€ì—° í­ë°œ**ì´ í„°ì ¸ 300 ê³ ì • í”¼í•´ë¥¼ ì…ì—ˆìŠµë‹ˆë‹¤!`, 'text-red-600');
        });
    }
    
    /** í”Œë ˆì´ì–´ ìŠ¤í‚¬ ì‚¬ìš© */
    function useSkill(pId, skillId) {
        if (currentPlayerIndex !== pId || players[pId].hp <= 0 || players[1 - pId].hp <= 0) return;

        const current = players[pId];
        const target = players[1 - pId];
        const skill = SKILLS.find(s => s.id === skillId);
        
        const calculatedCost = calculateSkillCost(skill);

        // ìŠ¤í‚¬ ì‚¬ìš© ì¡°ê±´ ì¬í™•ì¸ (MP ë° íŠ¹ìˆ˜ ì¡°ê±´)
        // MP ì†Œëª¨
        if (skill.type !== 'attack_hp_cost' && current.mp < calculatedCost) return;
        
        // HP ì†Œëª¨/íŠ¹ìˆ˜ ì¡°ê±´ ì²´í¬ (ë³µì¡í•œ ì¡°ê±´ì´ ë§ìœ¼ë¯€ë¡œ ì½”ë“œë¥¼ ê°„ê²°í•˜ê²Œ ìœ ì§€)
        if (skill.id === 39) { 
            if (current.hp < 100) return;
            const hpCost = Math.floor(current.hp * 0.1);
            current.hp -= hpCost;
            addLog(`**ìƒëª… ì „í™˜**ì˜ ëŒ€ê°€ë¡œ HP ${hpCost}ë¥¼ ì†Œëª¨í–ˆìŠµë‹ˆë‹¤.`, 'text-yellow-500');
        } else if (skill.id === 16 && current.hp < 100) { 
             return;
        } else if (skill.id === 19 && current.hp > 300) { 
             return;
        } else if (skill.id === 30 && current.hp >= MAX_HP * 0.2) { 
             return;
        } else if (skill.id === 35 && target.defense < 15) { 
             return;
        }
        
        // í•„ë“œ ìŠ¤í‚¬ ì‚¬ìš© ë¶ˆê°€ ì¡°ê±´
        if (skill.type.startsWith('field_') && FIELD_EFFECT.type !== null) return;
        
        // íšŒë³µ ë´‰ì‡„ ìƒíƒœì¼ ë•Œ íšŒë³µ/ë°©ì–´ ìŠ¤í‚¬ ì‚¬ìš© ë¶ˆê°€
        const healBlockEffect = current.status_effects.find(e => e.name === 'íšŒë³µ ë´‰ì‡„');
        if (healBlockEffect && (skill.type.includes('heal') || skill.type === 'defense_last_stand')) return;


        // MP ì†Œëª¨ ì²˜ë¦¬ (HP ì†Œëª¨ ìŠ¤í‚¬ ì œì™¸)
        if (skill.id !== 39) {
            current.mp -= calculatedCost;
        }
        
        addLog(`**${current.name}**ê°€ **${skill.name}** ìŠ¤í‚¬ì„ ì‚¬ìš©í–ˆìŠµë‹ˆë‹¤. ${skill.id !== 39 ? `(MP -${calculatedCost})` : ''}`, 'text-green-400');

        // 0. í¡ê³µ(debuff_mp_reflect) ì²˜ë¦¬ (ìƒëŒ€ê°€ ë‚˜ì—ê²Œ ê±¸ì–´ë†“ì€ MP ë°˜ì‚¬ ë””ë²„í”„)
        const mpReflectEffect = target.status_effects.find(e => e.name === 'í¡ê³µ');
        if (mpReflectEffect && calculatedCost > 0) {
            const reflectedMP = Math.floor(calculatedCost * 0.5);
            current.mp = Math.min(current.max_mp, current.mp + reflectedMP); 
            target.mp = Math.min(target.max_mp, target.mp + reflectedMP); 
            addLog(`**í¡ê³µ** ë°œë™! ${target.name}ì—ê²Œ ì†Œëª¨ MPì˜ 50%ì¸ ${reflectedMP} MPë¥¼ ëŒë ¤ë°›ì•˜ìŠµë‹ˆë‹¤.`, 'text-indigo-300');
        }
        
        // 1. ìƒíƒœ ë³€ìˆ˜ ê³„ì‚°
        let totalAttack = current.base_attack;
        let finalDefense = target.defense;
        let isTrueDamage = skill.type === 'attack_true_damage';
        let isCritVulnerable = false;
        let isMagicAttack = skill.cost > 0 && skill.type.includes('attack'); 

        // ê°€ì†ì¥ (field_haste_boost) ê³µê²©ë ¥ ì¦ê°€
        if (FIELD_EFFECT.type === 'field_haste_boost') {
            totalAttack += 100;
        }

        // ê³µê²©ìì—ê²Œ ê±¸ë¦° 'ë¬´ë ¥í™”' ë””ë²„í”„ í™•ì¸ (ê³µê²©ë ¥ ê°ì†Œ)
        current.status_effects.filter(e => e.name === 'ë¬´ë ¥í™”').forEach(() => {
            totalAttack *= 0.6; // 40% ê³µê²©ë ¥ ê°ì†Œ
            addLog(`*ë¬´ë ¥í™”* ë””ë²„í”„ë¡œ ì¸í•´ ${current.name}ì˜ ê³µê²©ë ¥ì´ ê°ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.`, 'text-yellow-500');
        });

        // íƒ€ê²Ÿì—ê²Œ ê±¸ë¦° 'ê¸‰ì†Œ ë…¸ì¶œ' ë””ë²„í”„ í™•ì¸ (ì¹˜ëª…íƒ€ í™•ë¥  ë¶€ì—¬)
        target.status_effects.filter(e => e.name === 'ê¸‰ì†Œ ë…¸ì¶œ').forEach(() => {
            if (Math.random() < 0.5) { 
                isCritVulnerable = true;
                addLog(`*ê¸‰ì†Œ ë…¸ì¶œ* ë””ë²„í”„ ë°œë™! ${target.name}ì€(ëŠ”) ì¹˜ëª…íƒ€ í”¼í•´ë¥¼ ì…ìŠµë‹ˆë‹¤.`, 'text-red-600');
            }
        });
        
        // íƒ€ê²Ÿì—ê²Œ ê±¸ë¦° 'ë°©ì–´ë ¥ 50% ê°ì†Œ' ë””ë²„í”„ í™•ì¸
        target.status_effects.filter(e => e.name === 'ë°©ì–´ë ¥ 50% ê°ì†Œ').forEach(() => {
            finalDefense *= 0.5;
            addLog(`*ë°©ì–´ë ¥ 50% ê°ì†Œ* ë””ë²„í”„ë¡œ ì¸í•´ ${target.name}ì˜ ë°©ì–´ë ¥ì´ ì ˆë°˜ìœ¼ë¡œ ê°ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.`, 'text-red-500');
        });

        // íƒ€ê²Ÿì—ê²Œ ê±¸ë¦° 'ë°©ì–´ë ¥ 10 ê°ì†Œ (ì¼ì‹œì )' ë””ë²„í”„ í™•ì¸ (ê²€í’ì°¸)
        let tempDefenseReduction = 0;
        target.status_effects.filter(e => e.name === 'ë°©ì–´ë ¥ 10 ê°ì†Œ (ì¼ì‹œì )').forEach(e => {
            tempDefenseReduction += 10;
        });
        if (tempDefenseReduction > 0) {
            finalDefense = Math.max(0, finalDefense - tempDefenseReduction);
            addLog(`*ë°©ì–´ë ¥ 10 ê°ì†Œ (ì¼ì‹œì )* ë””ë²„í”„ë¡œ ì¸í•´ ${target.name}ì˜ ë°©ì–´ë ¥ì´ ${tempDefenseReduction} ê°ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.`, 'text-red-500');
        }

        // 2. ìŠ¤í‚¬ íƒ€ì…ë³„ íš¨ê³¼ ì ìš©
        let damageDealt = 0;
        let healAmount = 0;
        
        if (skill.type.startsWith('attack') || skill.type.startsWith('debuff_crit_vulnerable')) {
            // ê³µê²© í”¼í•´ ê³„ì‚°
            let baseDamage = totalAttack * skill.damage_multiplier;
            
            // ë§ˆë ¥ í¬ê²© (ID 33) ì¶”ê°€ í”¼í•´
            if (skill.id === 33) {
                baseDamage += current.mp;
                addLog(`**ë§ˆë ¥ í¬ê²©** íš¨ê³¼ë¡œ MPì— ë¹„ë¡€í•˜ì—¬ ${current.mp}ì˜ ì¶”ê°€ í”¼í•´ê°€ ë°œìƒí•©ë‹ˆë‹¤.`, 'text-yellow-300');
            }

            let preDefenseDamage = baseDamage;

            // ë°©ì–´ë ¥ ì ìš©
            if (!isTrueDamage) {
                preDefenseDamage = (baseDamage / (1 + finalDefense / 100));
            }

            let critMultiplier = isCritVulnerable ? 2.0 : 1.0;

            // ì§‘ì¤‘ ì‚¬ê²© (ID 32) í¬ë¦¬í‹°ì»¬ í™•ë¥  ì ìš©
            const isMultihitCrit = skill.id === 32;

            // ë³µìˆ˜ì˜ ì¼ê²© (ID 24) ì¡°ê±´ë¶€ ì¹˜ëª…íƒ€ ì²´í¬
            if (skill.id === 24) {
                const hasDebuff = current.status_effects.some(e => e.type.includes('debuff') && e.name !== 'ë§¹ë… ì£¼ì…' && e.name !== 'í„´ ìŠ¤í‚µ (ìƒëŒ€)'); 
                if (hasDebuff) {
                    critMultiplier = 3.0; // 3.0ë°° ì¹˜ëª…íƒ€
                    addLog(`**ë³µìˆ˜ì˜ ì¼ê²©** ì¡°ê±´ ë§Œì¡±! ${current.name}ì´(ê°€) 3.0ë°° ì¹˜ëª…íƒ€ í”¼í•´ë¥¼ ì…í™ë‹ˆë‹¤.`, 'text-red-600');
                } else {
                    critMultiplier = 1.0; 
                    addLog(`**ë³µìˆ˜ì˜ ì¼ê²©** ì¡°ê±´ ë¶ˆë§Œì¡±. ì¼ë°˜ ê³µê²©ì´ ë‚˜ê°‘ë‹ˆë‹¤.`, 'text-gray-400');
                }
            }

            let finalDamage = preDefenseDamage * critMultiplier;
            
            let hits = skill.hits || 1;
            let totalEffectiveDamage = 0;
            let isReflected = false;
            let isCountered = false; 

            // íšŒí”¼ ì²´í¬
            const evadeBuff = target.status_effects.find(e => e.name === 'í™˜ì˜ ë¶„ì‹ ');
            if (evadeBuff && Math.random() < 0.5) {
                addLog(`**í™˜ì˜ ë¶„ì‹ ** íš¨ê³¼ë¡œ ${target.name}ì´(ê°€) ê³µê²©ì„ ì™„ì „íˆ íšŒí”¼í–ˆìŠµë‹ˆë‹¤!`, 'text-blue-400');
                target.status_effects = target.status_effects.filter(e => e.name !== 'í™˜ì˜ ë¶„ì‹ '); 
                totalEffectiveDamage = 0;
            } else {

                // ì›ì†Œ ë°˜ì‚¬ë§‰ (ID 21) ì²´í¬
                const reflectBuff = target.status_effects.find(e => e.name === 'ì›ì†Œ ë°˜ì‚¬ë§‰');
                if (reflectBuff && isMagicAttack) {
                    isReflected = true;
                    addLog(`**ì›ì†Œ ë°˜ì‚¬ë§‰** ë°œë™! ${current.name}ì˜ ë§ˆë²• ê³µê²©ì´ 100% ë°˜ì‚¬ë©ë‹ˆë‹¤.`, 'text-blue-400');
                    target.status_effects = target.status_effects.filter(e => e.name !== 'ì›ì†Œ ë°˜ì‚¬ë§‰'); 
                    
                    const reflectedDamage = Math.max(1, Math.floor(finalDamage * hits * diceModifier));
                    current.hp -= reflectedDamage;
                    addLog(`${current.name}ì´(ê°€) ë°˜ì‚¬ í”¼í•´ ${reflectedDamage}ë¥¼ ì…ì—ˆìŠµë‹ˆë‹¤.`, 'text-red-500');
                    
                    totalEffectiveDamage = 0;
                } else {

                    for (let i = 0; i < hits; i++) {
                        let hitCritMultiplier = critMultiplier;
                        let hitDamage = (preDefenseDamage / hits);

                        // ì§‘ì¤‘ ì‚¬ê²© (ID 32) ê°œë³„ ì¹˜ëª…íƒ€ ì ìš©
                        if (isMultihitCrit && Math.random() < 0.4) {
                            hitCritMultiplier = 2.0; 
                            addLog(`ì§‘ì¤‘ ì‚¬ê²© ${i + 1}íƒ€: ì¹˜ëª…íƒ€ ë°œìƒ!`, 'text-red-500');
                        } else if (isMultihitCrit) {
                            hitCritMultiplier = 1.0;
                        }
                        
                        hitDamage *= hitCritMultiplier;

                        // ì£¼ì‚¬ìœ„ ë³´ì • ì ìš©
                        let effectiveDamage = Math.max(1, Math.floor(hitDamage * diceModifier));
                        
                        // í˜¼ëˆì¥ (field_random_damage) ì ìš©: -50% ~ +50%
                        if (FIELD_EFFECT.type === 'field_random_damage') {
                            const randomModifier = 1 + (Math.random() * 1.0 - 0.5); // 0.5 ~ 1.5
                            effectiveDamage = Math.floor(effectiveDamage * randomModifier);
                            addLog(`**í˜¼ëˆì¥** íš¨ê³¼ë¡œ í”¼í•´ëŸ‰ì— ${Math.round((randomModifier - 1) * 100)}%ì˜ ë¬´ì‘ìœ„ ë³€ë™ì´ ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤.`, 'text-purple-300');
                        }
                        
                        // ê¶ê·¹ì˜ ì¸ë‚´ (ID 26) ë°ë¯¸ì§€ ìº¡ ì ìš©
                        const capEffect = target.status_effects.find(e => e.name === 'ê¶ê·¹ì˜ ì¸ë‚´');
                        if (capEffect) {
                            effectiveDamage = Math.min(effectiveDamage, 200);
                            addLog(`*ê¶ê·¹ì˜ ì¸ë‚´* íš¨ê³¼ë¡œ í”¼í•´ê°€ 200ìœ¼ë¡œ ì œí•œë˜ì—ˆìŠµë‹ˆë‹¤.`, 'text-gray-500');
                        }

                        // í”¼í•´ í¡ìˆ˜ (ì‰´ë“œ) ì²˜ë¦¬
                        if (target.shield_value > 0) {
                            const damageToShield = Math.min(effectiveDamage, target.shield_value);
                            target.shield_value -= damageToShield;
                            effectiveDamage -= damageToShield;
                            if (target.shield_value <= 0) {
                                addLog(`${target.name}ì˜ ì‰´ë“œê°€ íŒŒê´´ë˜ì—ˆìŠµë‹ˆë‹¤.`, 'text-gray-500');
                                target.shield_value = 0;
                            }
                        }

                        // ë‚¨ì€ í”¼í•´ HP ì ìš©
                        if (effectiveDamage > 0) {
                            target.hp -= effectiveDamage;
                        }
                        totalEffectiveDamage += effectiveDamage;

                        // íŒŒì‡„ì˜ ì¹´ìš´í„° (ID 28) ì²´í¬
                        const counterDebuff = target.status_effects.find(e => e.name === 'íŒŒì‡„ì˜ ì¹´ìš´í„°'); 
                        
                        if (effectiveDamage > 0 && counterDebuff) {
                            isCountered = true; 
                            current.status_effects = current.status_effects.filter(e => e.name !== 'ë°©ì–´ë ¥ 50% ê°ì†Œ');
                            current.status_effects.push({ name: 'ë°©ì–´ë ¥ 50% ê°ì†Œ', duration: 2, type: 'debuff' });
                            addLog(`**íŒŒì‡„ì˜ ì¹´ìš´í„°** ë°œë™! ${current.name}ì—ê²Œ ë°©ì–´ë ¥ 50% ê°ì†Œ ë””ë²„í”„ë¥¼ ê±¸ì—ˆìŠµë‹ˆë‹¤.`, 'text-red-400');
                        }
                    }
                }
            }
            
            // íŒŒì‡„ì˜ ì¹´ìš´í„° ë””ë²„í”„ ë²„í”„ëŠ” ê³µê²©ë°›ì€ í›„ ì œê±° (1í„´ ì§€ì†)
            if (isCountered) {
                if (target.status_effects.some(e => e.name === 'íŒŒì‡„ì˜ ì¹´ìš´í„°')) {
                     target.status_effects = target.status_effects.filter(e => e.name !== 'íŒŒì‡„ì˜ ì¹´ìš´í„°');
                     addLog(`íŒŒì‡„ì˜ ì¹´ìš´í„° íš¨ê³¼ê°€ í•´ì œë˜ì—ˆìŠµë‹ˆë‹¤.`, 'text-gray-500');
                }
            }
            
            // í”¼í•´ ì „í™˜ (ID 23) MP íšŒë³µ ì²´í¬
            const mpRedirectEffect = target.status_effects.find(e => e.name === 'í”¼í•´ ì „í™˜');
            if (mpRedirectEffect) {
                const mpGain = Math.floor(totalEffectiveDamage * 0.5); 
                target.mp = Math.min(target.max_mp, target.mp + mpGain); 
                addLog(`**í”¼í•´ ì „í™˜** íš¨ê³¼ë¡œ ${mpGain} MPë¥¼ íšŒë³µí–ˆìŠµë‹ˆë‹¤.`, 'text-blue-300');
            }

            // ë¯¸ë‹¤ìŠ¤ ì¥ (field_damage_to_mp) MP íšŒë³µ ì²´í¬
            if (FIELD_EFFECT.type === 'field_damage_to_mp' && totalEffectiveDamage > 0) {
                const mpGain = Math.floor(totalEffectiveDamage * 0.1); 
                current.mp = Math.min(current.max_mp, current.mp + mpGain); 
                addLog(`**ë¯¸ë‹¤ìŠ¤ ì¥** íš¨ê³¼ë¡œ ì…íŒ í”¼í•´ì˜ 10%ì¸ ${mpGain} MPë¥¼ íšŒë³µí–ˆìŠµë‹ˆë‹¤.`, 'text-purple-300');
            }


            damageDealt = totalEffectiveDamage;
            
            if (damageDealt > 0) {
                addLog(`${target.name}ì—ê²Œ ${Math.floor(damageDealt)}ì˜ í”¼í•´ë¥¼ ì…í˜”ìŠµë‹ˆë‹¤.`, 'text-red-300');
            }

            // --- ì¶”ê°€ íš¨ê³¼ ---
            if (skill.type === 'attack_heal') {
                healAmount = Math.floor(damageDealt * 0.5 * diceModifier); 
                current.hp = Math.min(MAX_HP, current.hp + healAmount);
                addLog(`ì˜í˜¼ í¡ìˆ˜ íš¨ê³¼ë¡œ ${healAmount}ì˜ ì²´ë ¥ì„ íšŒë³µí–ˆìŠµë‹ˆë‹¤.`, 'text-blue-300');
            } else if (skill.type === 'attack_selfdmg') {
                let selfDamage = Math.floor(MAX_HP * 0.1);
                const damageReductionEffect = current.status_effects.find(e => e.name === 'í”¼í•´ ê°ì†Œ');
                if(damageReductionEffect) {
                    selfDamage *= (damageReductionEffect.duration > 0 && damageReductionEffect.name === 'ìµœí›„ì˜ ì €í•­' ? 0.5 : 0.7);
                }
                current.hp -= selfDamage;
                addLog(`ë§ˆë²• í­ì£¼ì˜ ë°˜ë™ìœ¼ë¡œ ${Math.floor(selfDamage)}ì˜ í”¼í•´ë¥¼ ì…ì—ˆìŠµë‹ˆë‹¤.`, 'text-yellow-500');
            } else if (skill.type === 'attack_dot') {
                target.status_effects = target.status_effects.filter(e => e.name !== 'ë§¹ë… ì£¼ì…');
                target.status_effects.push({ name: 'ë§¹ë… ì£¼ì…', duration: 3, type: 'debuff_dot' });
                addLog(`${target.name}ì—ê²Œ 3í„´ ë™ì•ˆ ì¤‘ë… ë””ë²„í”„ë¥¼ ê±¸ì—ˆìŠµë‹ˆë‹¤.`, 'text-red-400');
            } else if (skill.id === 31) {
                target.mp = Math.max(0, target.mp - 10);
                addLog(`${target.name}ì˜ MP 10ì„ ê°ì†Œì‹œì¼°ìŠµë‹ˆë‹¤.`, 'text-indigo-400');
            } else if (skill.id === 36) {
                target.status_effects = target.status_effects.filter(e => e.name !== 'íšŒë³µ ê°ì†Œ');
                target.status_effects.push({ name: 'íšŒë³µ ê°ì†Œ', duration: 3, type: 'debuff_heal_reduc' });
                addLog(`${target.name}ì—ê²Œ 3í„´ ë™ì•ˆ íšŒë³µ íš¨ê³¼ 50% ê°ì†Œ ë””ë²„í”„ë¥¼ ê±¸ì—ˆìŠµë‹ˆë‹¤.`, 'text-red-400');
            } else if (skill.id === 37) {
                diceModifier = 1.0;
                $diceText.textContent = `ìš´ëª… ì£¼ì‚¬ìœ„: ëª¨ë“  íš¨ê³¼ +0% ë³´ì • (ì‹ ì† ê²©íŒŒ ë°œë™)`;
                addLog(`**ì‹ ì† ê²©íŒŒ** íš¨ê³¼ë¡œ ì´ë²ˆ í„´ì˜ ìš´ëª… ì£¼ì‚¬ìœ„ íš¨ê³¼ê°€ 1.0ìœ¼ë¡œ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.`, 'text-indigo-400');
            } else if (skill.id === 38) {
                target.defense = Math.max(0, target.defense - 5);
                addLog(`${target.name}ì˜ ë°©ì–´ë ¥ì´ ì˜êµ¬ì ìœ¼ë¡œ 5 ê°ì†Œí–ˆìŠµë‹ˆë‹¤! (í˜„ì¬ ${target.defense})`, 'text-red-600');
            } else if (skill.id === 40) {
                target.status_effects = target.status_effects.filter(e => e.name !== 'íšŒë³µ ë´‰ì‡„');
                target.status_effects.push({ name: 'íšŒë³µ ë´‰ì‡„', duration: 2, type: 'debuff_heal_block' });
                addLog(`${target.name}ì—ê²Œ 2í„´ ë™ì•ˆ íšŒë³µ ìŠ¤í‚¬ ì‚¬ìš©ì„ ë´‰ì‡„í•˜ëŠ” ë””ë²„í”„ë¥¼ ê±¸ì—ˆìŠµë‹ˆë‹¤.`, 'text-red-400');
            } else if (skill.id === 25) {
                target.status_effects.push({ name: 'ë°©ì–´ë ¥ 10 ê°ì†Œ (ì¼ì‹œì )', duration: 2, type: 'debuff_defense_temp' });
                addLog(`${target.name}ì—ê²Œ 2í„´ ë™ì•ˆ ë°©ì–´ë ¥ 10 ê°ì†Œ ë””ë²„í”„ë¥¼ ê±¸ì—ˆìŠµë‹ˆë‹¤.`, 'text-red-400');
            }
            
        } else if (skill.type.startsWith('debuff_')) {
             // ë””ë²„í”„ (ê³µê²©ì´ ì•„ë‹Œ ìˆœìˆ˜ ë””ë²„í”„)
            switch(skill.type) {
                case "debuff_skip_opponent": {
                    target.status_effects = target.status_effects.filter(e => e.name !== 'í„´ ìŠ¤í‚µ (ìƒëŒ€)'); 
                    target.status_effects.push({ name: 'í„´ ìŠ¤í‚µ (ìƒëŒ€)', duration: 2, type: 'debuff_skip' });
                    addLog(`${target.name}ì—ê²Œ **ì‹œê°„ ì •ì§€** íš¨ê³¼ë¥¼ ê±¸ì—ˆìŠµë‹ˆë‹¤. ë‹¤ìŒ 2í„´ì„ ìƒê²Œ ë©ë‹ˆë‹¤.`, 'text-red-500');
                    break;
                }
                case "debuff_delayed_damage": {
                    target.status_effects = target.status_effects.filter(e => e.name !== 'ì§€ì—° í­ë°œ'); 
                    target.status_effects.push({ name: 'ì§€ì—° í­ë°œ', duration: 2, type: 'debuff_delayed' });
                    addLog(`${target.name}ì—ê²Œ **ì§€ì—° í­ë°œ** ë””ë²„í”„ë¥¼ ê±¸ì—ˆìŠµë‹ˆë‹¤. 2í„´ í›„ í­ë°œí•©ë‹ˆë‹¤.`, 'text-red-500');
                    break;
                }
                case "debuff": {
                    target.status_effects = target.status_effects.filter(e => e.name !== 'ë¬´ë ¥í™”'); 
                    target.status_effects.push({ name: 'ë¬´ë ¥í™”', duration: 2, type: 'debuff' });
                    addLog(`${target.name}ì—ê²Œ 2í„´ ë™ì•ˆ ê³µê²©ë ¥ 40% ê°ì†Œ ë””ë²„í”„ë¥¼ ê±¸ì—ˆìŠµë‹ˆë‹¤.`, 'text-red-400');
                    break;
                }
                case "debuff_mp_reflect": {
                    target.status_effects = target.status_effects.filter(e => e.name !== 'í¡ê³µ'); 
                    target.status_effects.push({ name: 'í¡ê³µ', duration: 2, type: 'debuff_mp_reflect' });
                    addLog(`${target.name}ì—ê²Œ 2í„´ ë™ì•ˆ MP ì†Œëª¨ ì‹œ 50%ë¥¼ í¡ìˆ˜í•˜ëŠ” ë””ë²„í”„ë¥¼ ê±¸ì—ˆìŠµë‹ˆë‹¤.`, 'text-red-400');
                    break;
                }
            }
        } else if (skill.type.startsWith('field_')) {
            // í•„ë“œ ìŠ¤í‚¬ ë°œë™ (ì´ë¯¸ ì²´í¬í–ˆìœ¼ë¯€ë¡œ ë°”ë¡œ ì„¤ì •)
            FIELD_EFFECT = {
                id: skill.id,
                name: skill.name,
                type: skill.type,
                duration: skill.duration
            };
            addLog(`**${skill.name}** í•„ë“œê°€ ë°œë™ë˜ì—ˆìŠµë‹ˆë‹¤! ${skill.duration}í„´ ë™ì•ˆ ì§€ì†ë©ë‹ˆë‹¤.`, 'text-purple-500');

        } else {
            // ë²„í”„, ìœ í‹¸ë¦¬í‹°, í
            switch (skill.type) {
                case "buff": 
                case "defense_last_stand": {
                    const duration = skill.id === 19 ? 3 : 2;
                    current.status_effects = current.status_effects.filter(e => e.name !== 'í”¼í•´ ê°ì†Œ'); 
                    current.status_effects.push({ name: 'í”¼í•´ ê°ì†Œ', duration: duration, type: 'buff' });
                    addLog(`${duration}í„´ ë™ì•ˆ ë°›ëŠ” í”¼í•´ê°€ ${skill.id === 19 ? '50%' : '30%'} ê°ì†Œí•©ë‹ˆë‹¤.`, 'text-green-300');

                    if (skill.id === 19) {
                        current.hp = Math.min(MAX_HP, current.hp + 100);
                        addLog(`HP 100ì„ íšŒë³µí–ˆìŠµë‹ˆë‹¤.`, 'text-blue-300');
                    }
                    break;
                }
                case "utility_mp_max_increase":
                case "utility_mp_max_increase_heavy": {
                    const increase = skill.mp_increase;
                    const restore = skill.mp_restore;
                    
                    current.max_mp += increase;
                    current.mp = Math.min(current.max_mp, current.mp + restore);
                    
                    addLog(`**${skill.name}** ë°œë™! ìµœëŒ€ MPê°€ ì˜êµ¬ì ìœ¼ë¡œ ${increase} ì¦ê°€í•˜ì—¬ ${current.max_mp}ì´(ê°€) ë˜ì—ˆìŠµë‹ˆë‹¤. MP ${restore} íšŒë³µ.`, 'text-blue-300');
                    break;
                }
                case "buff_counter_debuff": {
                    current.status_effects = current.status_effects.filter(e => e.name !== 'íŒŒì‡„ì˜ ì¹´ìš´í„°');
                    current.status_effects.push({ name: 'íŒŒì‡„ì˜ ì¹´ìš´í„°', duration: 1, type: 'buff_counter' });
                    addLog(`1í„´ ë™ì•ˆ ê³µê²©ì„ ë°›ì„ ê²½ìš° ìƒëŒ€ì—ê²Œ ë°©ì–´ë ¥ ê°ì†Œ ë””ë²„í”„ë¥¼ ê²ë‹ˆë‹¤.`, 'text-green-300');
                    break;
                }
                case "buff_reflect_magic": {
                    current.status_effects = current.status_effects.filter(e => e.name !== 'ì›ì†Œ ë°˜ì‚¬ë§‰');
                    current.status_effects.push({ name: 'ì›ì†Œ ë°˜ì‚¬ë§‰', duration: 1, type: 'buff_reflect' });
                    addLog(`1í„´ ë™ì•ˆ ë§ˆë²• í”¼í•´(MP ì†Œëª¨ ê³µê²©)ë¥¼ 100% ë°˜ì‚¬í•©ë‹ˆë‹¤.`, 'text-green-300');
                    break;
                }
                case "defense_shield_absorb": {
                    if (current.shield_value === 0) {
                        current.shield_value = skill.absorb_amount;
                        current.status_effects = current.status_effects.filter(e => e.name !== 'í•„ì‚¬ì˜ ë°©íŒ¨'); 
                        current.status_effects.push({ name: 'í•„ì‚¬ì˜ ë°©íŒ¨', duration: 1, type: 'defense_shield' });
                        addLog(`300 í”¼í•´ë¥¼ í¡ìˆ˜í•˜ëŠ” ì‹¤ë“œë¥¼ ì–»ì—ˆìŠµë‹ˆë‹¤.`, 'text-blue-300');
                    } else {
                        addLog(`ì‹¤ë“œê°€ ì´ë¯¸ ì¡´ì¬í•˜ì—¬ í•„ì‚¬ì˜ ë°©íŒ¨ë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`, 'text-yellow-500');
                        current.mp += calculatedCost; // MP ë°˜í™˜ (í•„ë“œ íš¨ê³¼ê°€ ì ìš©ëœ ì½”ìŠ¤íŠ¸ë¥¼ ë°˜í™˜)
                    }
                    break;
                }
                case "defense_damage_cap": {
                    current.status_effects = current.status_effects.filter(e => e.name !== 'ê¶ê·¹ì˜ ì¸ë‚´');
                    current.status_effects.push({ name: 'ê¶ê·¹ì˜ ì¸ë‚´', duration: 2, type: 'defense_cap' });
                    addLog(`2í„´ ë™ì•ˆ ë°›ëŠ” í”¼í•´ê°€ ìµœëŒ€ 200ìœ¼ë¡œ ì œí•œë©ë‹ˆë‹¤.`, 'text-green-300');
                    break;
                }
                case "buff_redirect_damage": {
                    current.status_effects = current.status_effects.filter(e => e.name !== 'í”¼í•´ ì „í™˜');
                    current.status_effects.push({ name: 'í”¼í•´ ì „í™˜', duration: 2, type: 'buff_redirect' });
                    addLog(`2í„´ ë™ì•ˆ ë°›ëŠ” í”¼í•´ì˜ 50%ë¥¼ MPë¡œ ì „í™˜í•©ë‹ˆë‹¤.`, 'text-green-300');
                    break;
                }
                case "buff_evade": {
                    current.status_effects = current.status_effects.filter(e => e.name !== 'í™˜ì˜ ë¶„ì‹ ');
                    current.status_effects.push({ name: 'í™˜ì˜ ë¶„ì‹ ', duration: 1, type: 'buff_evade' });
                    addLog(`ë‹¤ìŒ í„´ ìƒëŒ€ì˜ ê³µê²©ì„ 50% í™•ë¥ ë¡œ íšŒí”¼í•©ë‹ˆë‹¤.`, 'text-green-300');
                    break;
                }
                case "debuff_mp_steal": {
                    const stolenMP = 20;
                    const actualStolen = Math.min(stolenMP, target.mp);
                    target.mp = Math.max(0, target.mp - actualStolen);
                    current.mp = Math.min(current.max_mp, current.mp + actualStolen); 
                    addLog(`${target.name}ì˜ MP ${actualStolen}ì„(ë¥¼) ê°•íƒˆí–ˆìŠµë‹ˆë‹¤.`, 'text-indigo-300');
                    break;
                }
                case "heal_cleanse": {
                    const healReductionEffect = current.status_effects.find(e => e.name === 'íšŒë³µ ê°ì†Œ');
                    let reduction = healReductionEffect ? 0.5 : 1.0;

                    healAmount = Math.floor(MAX_HP * 0.15 * diceModifier * reduction);
                    current.hp = Math.min(MAX_HP, current.hp + healAmount);
                    
                    const hostileIndex = current.status_effects.findIndex(e => e.type.includes('debuff') || e.name === 'ë§¹ë… ì£¼ì…' || e.name === 'í„´ ìŠ¤í‚µ (ìƒëŒ€)' || e.name === 'ë°©ì–´ë ¥ 10 ê°ì†Œ (ì¼ì‹œì )' || e.name === 'íšŒë³µ ê°ì†Œ' || e.name === 'íšŒë³µ ë´‰ì‡„' || e.name === 'ê¸‰ì†Œ ë…¸ì¶œ');
                    if (hostileIndex !== -1) {
                        const removedName = current.status_effects[hostileIndex].name;
                        current.status_effects.splice(hostileIndex, 1);
                        addLog(`**${removedName}** ë””ë²„í”„ê°€ ì œê±°ë˜ì—ˆìŠµë‹ˆë‹¤.`, 'text-blue-300');
                    }
                    addLog(`ì²´ë ¥ ${healAmount} íšŒë³µ.`, 'text-blue-300');
                    break;
                }
                case "cleanse_all": {
                    const hostileEffects = current.status_effects.filter(e => e.type.includes('debuff') || e.name === 'ë§¹ë… ì£¼ì…' || e.name === 'í„´ ìŠ¤í‚µ (ìƒëŒ€)' || e.name === 'ë°©ì–´ë ¥ 10 ê°ì†Œ (ì¼ì‹œì )' || e.name === 'íšŒë³µ ê°ì†Œ' || e.name === 'íšŒë³µ ë´‰ì‡„' || e.name === 'ê¸‰ì†Œ ë…¸ì¶œ');
                    hostileEffects.forEach(e => {
                        addLog(`**${e.name}** ë””ë²„í”„ê°€ ì œê±°ë˜ì—ˆìŠµë‹ˆë‹¤.`, 'text-blue-300');
                    });
                    current.status_effects = current.status_effects.filter(e => e.type.includes('buff') || e.name === 'í•„ì‚¬ì˜ ë°©íŒ¨'); 
                    current.mp = Math.min(current.max_mp, current.mp + 10); 
                    addLog(`ëª¨ë“  í•´ë¡œìš´ íš¨ê³¼ë¥¼ ì œê±°í•˜ê³  MP 10ì„ íšŒë³µí–ˆìŠµë‹ˆë‹¤.`, 'text-blue-300');
                    break;
                }
                case "utility": {
                    const healReductionEffect = current.status_effects.find(e => e.name === 'íšŒë³µ ê°ì†Œ');
                    let reduction = healReductionEffect ? 0.5 : 1.0;

                    healAmount = Math.floor(MAX_HP * 0.05 * diceModifier * reduction); 
                    current.hp = Math.min(MAX_HP, current.hp + healAmount);
                    current.mp = Math.min(current.max_mp, current.mp + 30); 
                    addLog(`ì²´ë ¥ ${healAmount} íšŒë³µ ë° MP 30 ì¦ê°€.`, 'text-blue-300');
                    break;
                }
                case "utility_dice_control": {
                    current.status_effects = current.status_effects.filter(e => e.name !== 'ìš´ëª… ì¡°ì‘'); 
                    current.status_effects.push({ name: 'ìš´ëª… ì¡°ì‘', duration: 1, type: 'buff_dice' });
                    addLog(`ë‹¤ìŒ í„´ì˜ ìš´ëª… ì£¼ì‚¬ìœ„ë¥¼ ìœ ë¦¬í•˜ê²Œ ì¡°ì‘í•©ë‹ˆë‹¤.`, 'text-indigo-400');
                    break;
                }
                case "utility_transfer_hp_mp": {
                    const hpCost = Math.floor(current.hp * 0.2);
                    current.hp -= hpCost;
                    current.mp = Math.min(current.max_mp, current.mp + hpCost); 
                    addLog(`HP ${hpCost}ë¥¼ ì†Œëª¨í•˜ì—¬ MP ${hpCost}ë¥¼ ì–»ì—ˆìŠµë‹ˆë‹¤.`, 'text-indigo-300');
                    break;
                }
                case "defense_dice": {
                    current.status_effects = current.status_effects.filter(e => e.name !== 'ìš´ëª… ê±°ë¶€'); 
                    current.status_effects.push({ name: 'ìš´ëª… ê±°ë¶€', duration: 1, type: 'buff_negate' });
                    addLog(`ë‹¤ìŒ í„´ì— ë°œë™í•  ìš´ëª… ì£¼ì‚¬ìœ„ íš¨ê³¼ë¥¼ ë¬´ì‹œí•  ì¤€ë¹„ë¥¼ í•©ë‹ˆë‹¤.`, 'text-indigo-400');
                    break;
                }
                case "utility_swap_stats": {
                    const tempHp = current.hp;
                    current.hp = target.hp;
                    target.hp = tempHp;
                    addLog(`**ì—­ì „ì˜ ê¸°íšŒ** ë°œë™! ${current.name}ê³¼ ${target.name}ì˜ HPê°€ ì„œë¡œ ë§ë°”ë€Œì—ˆìŠµë‹ˆë‹¤.`, 'text-red-600');
                    break;
                }
            }
        }
        
        // í„´ ì¢…ë£Œ ë° í”Œë ˆì´ì–´ ì „í™˜
        currentPlayerIndex = 1 - currentPlayerIndex;
        
        // ë‹¤ìŒ í„´ ì‹œì‘ (ë”œë ˆì´ ì—†ì´ ë°”ë¡œ)
        if (players[0].hp > 0 && players[1].hp > 0) {
            startTurn();
        } else {
            endGame();
        }
    }


    // --- ê²Œì„ ì‹œì‘ ---
    window.onload = () => {
        // Initial player setup (names only)
        players = [
            { id: 0, name: 'í”Œë ˆì´ì–´ 1', hp: MAX_HP, mp: BASE_MAX_MP, max_mp: BASE_MAX_MP, base_attack: BASE_ATTACK, defense: 10, selected_skills: [], status_effects: [], shield_value: 0 },
            { id: 1, name: 'í”Œë ˆì´ì–´ 2', hp: MAX_HP, mp: BASE_MAX_MP, max_mp: BASE_MAX_MP, base_attack: BASE_ATTACK, defense: 10, selected_skills: [], status_effects: [], shield_value: 0 }
        ];

        renderSkillSelection();
        updateUI(); 
    };
</script>
</body>
</html>